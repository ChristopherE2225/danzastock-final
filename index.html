<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danzastock - Inventario</title>
    <!-- Tailwind CSS via CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom animation for messages */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 text-gray-800">

    <!-- Main application container -->
    <div class="container mx-auto">
        <!-- Header and navigation buttons -->
        <header class="bg-white p-6 rounded-3xl shadow-lg mb-8 text-center">
            <h1 class="text-4xl md:text-5xl font-extrabold text-blue-900 mb-2 drop-shadow-md">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-500 to-indigo-600">Danzastock</span>
            </h1>
            <p class="text-xl text-gray-500">Gestión de Inventario de Danza</p>
            <div class="mt-4 flex flex-wrap justify-center space-x-2 md:space-x-4">
                <button id="materials-btn" class="view-btn py-2 px-6 rounded-full font-bold transition-colors duration-300 text-lg shadow-lg transform hover:scale-105 bg-indigo-600 text-white">
                    Materiales
                </button>
                <button id="costumes-btn" class="view-btn py-2 px-6 rounded-full font-bold transition-colors duration-300 text-lg shadow-lg transform hover:scale-105 bg-gray-200 text-gray-700 hover:bg-indigo-200">
                    Vestuarios
                </button>
            </div>
        </header>

        <!-- Main content area with form and list -->
        <main class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Form column -->
            <div class="md:col-span-1 bg-white p-6 rounded-3xl shadow-lg h-fit sticky top-4">
                <h2 id="form-title" class="text-3xl font-bold text-gray-800 mb-4 text-center">Añadir Material</h2>
                <form id="item-form" class="space-y-4">
                    <!-- Name Input -->
                    <div>
                        <label for="name" class="block text-gray-700 font-semibold mb-1">Nombre</label>
                        <input type="text" id="name" name="name" placeholder="Nombre del artículo" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-shadow">
                    </div>
                    <!-- Quantity Input (only for materials) -->
                    <div id="quantity-field">
                        <label for="quantity" class="block text-gray-700 font-semibold mb-1">Cantidad</label>
                        <input type="number" id="quantity" name="quantity" placeholder="Cantidad de piezas" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-shadow">
                    </div>
                    <!-- Status Dropdown -->
                    <div>
                        <label for="status" class="block text-gray-700 font-semibold mb-1">Estado</label>
                        <select id="status" name="status"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-shadow">
                            <option value="Almacén">Almacén</option>
                            <option value="Prestado">Prestado</option>
                            <option value="Reparación" id="repair-option">Reparación</option>
                            <option value="Perdido">Perdido</option>
                        </select>
                    </div>
                    <!-- Loaned To Input (only if status is 'Prestado') -->
                    <div id="loaned-field" class="hidden">
                        <label for="loanedTo" class="block text-gray-700 font-semibold mb-1">Prestado a</label>
                        <input type="text" id="loanedTo" name="loanedTo" placeholder="Nombre de la persona"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-shadow">
                    </div>
                    <!-- Submit Button -->
                    <button type="submit" id="submit-btn"
                            class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 rounded-xl text-lg shadow-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-400 focus:ring-opacity-75">
                        Añadir a Inventario
                    </button>
                </form>
                <button id="cancel-btn" class="mt-2 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-xl text-lg shadow-lg transition-all duration-200 transform hover:scale-105 hidden">
                    Cancelar
                </button>
            </div>

            <!-- List and search column -->
            <div class="md:col-span-2">
                <!-- Search bar -->
                <div class="mb-6">
                    <input type="text" id="search-input" placeholder="Buscar materiales..."
                           class="w-full p-3 border border-gray-300 rounded-full shadow-inner focus:outline-none focus:ring-2 focus:ring-purple-400 transition-shadow text-lg">
                </div>
                <!-- Message box -->
                <div id="message-box" class="hidden p-4 mb-4 rounded-xl shadow-lg text-center font-bold animate-fadeIn"></div>
                <!-- Inventory list container -->
                <div id="item-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p id="loading-message" class="col-span-full text-center text-gray-500 text-lg">Cargando...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK Imports -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <script>
        // DOM elements
        const viewBtns = document.querySelectorAll('.view-btn');
        const materialsBtn = document.getElementById('materials-btn');
        const costumesBtn = document.getElementById('costumes-btn');
        const formTitle = document.getElementById('form-title');
        const quantityField = document.getElementById('quantity-field');
        const repairOption = document.getElementById('repair-option');
        const loanedField = document.getElementById('loaned-field');
        const itemForm = document.getElementById('item-form');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const searchInput = document.getElementById('search-input');
        const itemList = document.getElementById('item-list');
        const messageBox = document.getElementById('message-box');
        const loadingMessage = document.getElementById('loading-message');

        // Global state
        let currentView = 'materials';
        let items = { materials: [], costumes: [] };
        let editingItem = null;
        let db;
        let auth;
        let userId;

        // Bloque de depuración:
        // Si no estás usando Vercel o necesitas probar en local, puedes pegar aquí tu configuración de Firebase.
        // Solo necesitas copiar el contenido del objeto `firebaseConfig` que te dio Firebase.
        const localFirebaseConfig = {
            apiKey: "AIzaSyALk8eY3cyM0yfIWCvHKTouos0bK0eIMMo",
            authDomain: "danzastock-app.firebaseapp.com",
            projectId: "danzastock-app",
            storageBucket: "danzastock-app.firebasestorage.app",
            messagingSenderId: "34990121437",
            appId: "1:34990121437:web:ec80cb15b63294db645634",
            measurementId: "G-8NWQSRN9VD"
        };
        // FIN del bloque de depuración

        // Firebase-related variables from the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : localFirebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Initializes Firebase and handles user authentication.
         */
        const initializeFirebase = async () => {
            try {
                // Initialize Firebase app
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                // Listen for authentication state changes
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated with UID:", userId);
                        setupFirestoreListeners();
                    } else {
                        // Sign in with the provided token if available
                        if (initialAuthToken) {
                            auth.signInWithCustomToken(initialAuthToken).catch(e => {
                                console.error("Custom token sign-in failed:", e);
                                // Fallback to anonymous sign-in if custom token fails
                                auth.signInAnonymously().catch(anonErr => console.error("Anonymous sign-in failed:", anonErr));
                            });
                        } else {
                            // If no token, sign in anonymously
                            auth.signInAnonymously().catch(e => console.error("Anonymous sign-in failed:", e));
                        }
                    }
                });
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                showMessage("Error al inicializar la base de datos.", 'error');
            }
        };

        /**
         * Sets up real-time listeners for Firestore collections.
         */
        const setupFirestoreListeners = () => {
            // Materials listener
            db.collection(`artifacts/${appId}/users/${userId}/materials`).onSnapshot((querySnapshot) => {
                const materials = [];
                querySnapshot.forEach((doc) => {
                    materials.push({ id: doc.id, ...doc.data() });
                });
                items.materials = materials;
                renderItems();
            }, (error) => {
                console.error("Error fetching materials:", error);
                showMessage("Error al cargar materiales.", 'error');
            });

            // Costumes listener
            db.collection(`artifacts/${appId}/users/${userId}/costumes`).onSnapshot((querySnapshot) => {
                const costumes = [];
                querySnapshot.forEach((doc) => {
                    costumes.push({ id: doc.id, ...doc.data() });
                });
                items.costumes = costumes;
                renderItems();
            }, (error) => {
                console.error("Error fetching costumes:", error);
                showMessage("Error al cargar vestuarios.", 'error');
            });

            // Hide loading message once data is loaded
            loadingMessage.classList.add('hidden');
        };

        /**
         * Displays a temporary message to the user.
         * @param {string} text - The message text.
         * @param {string} type - 'success' or 'error'.
         */
        const showMessage = (text, type = 'success') => {
            messageBox.textContent = text;
            messageBox.className = `p-4 mb-4 rounded-xl shadow-lg text-center font-bold animate-fadeIn ${
                type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`;
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        };

        /**
         * Renders the item list based on the current view and search query.
         */
        const renderItems = () => {
            const currentItems = items[currentView];
            const searchQuery = searchInput.value.toLowerCase();
            const filteredItems = currentItems.filter(item => item.name.toLowerCase().includes(searchQuery));

            itemList.innerHTML = '';
            if (filteredItems.length === 0) {
                itemList.innerHTML = `<p class="col-span-full text-center text-gray-500 text-lg">No se encontraron ${currentView}. ¡Intenta agregar uno!</p>`;
                return;
            }

            filteredItems.forEach(item => {
                const isCostume = currentView === 'costumes';
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl shadow-lg border-2 border-slate-200 hover:shadow-xl transition-shadow duration-300 transform hover:scale-105";

                const statusColor = item.status === 'Almacén' ? 'text-green-600' :
                                    item.status === 'Prestado' ? 'text-orange-600' :
                                    item.status === 'Reparación' ? 'text-yellow-600' :
                                    'text-red-600';

                card.innerHTML = `
                    <h3 class="font-bold text-lg text-indigo-800 break-words">${item.name}</h3>
                    ${!isCostume ? `<p class="text-gray-600">Cantidad: ${item.quantity}</p>` : ''}
                    <p class="text-gray-600">
                        Estado: <span class="font-semibold ${statusColor}">${item.status}</span>
                    </p>
                    ${item.status === 'Prestado' ? `<p class="text-gray-600">Prestado a: <span class="font-semibold text-blue-600">${item.loanedTo}</span></p>` : ''}
                    <div class="mt-4 flex justify-end space-x-2">
                        <button class="edit-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-opacity-75" data-id="${item.id}">
                            Editar
                        </button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75" data-id="${item.id}">
                            Eliminar
                        </button>
                    </div>
                `;

                // Add event listeners for edit and delete buttons
                card.querySelector('.edit-btn').addEventListener('click', () => handleEdit(item));
                card.querySelector('.delete-btn').addEventListener('click', () => handleDelete(item.id));

                itemList.appendChild(card);
            });
        };

        /**
         * Sets the form to edit an existing item.
         * @param {object} item - The item to edit.
         */
        const handleEdit = (item) => {
            editingItem = item;
            document.getElementById('name').value = item.name;
            document.getElementById('quantity').value = item.quantity;
            document.getElementById('status').value = item.status;
            document.getElementById('loanedTo').value = item.loanedTo || '';

            formTitle.textContent = `Editar ${currentView === 'materials' ? 'Material' : 'Vestuario'}`;
            submitBtn.textContent = 'Guardar Cambios';
            cancelBtn.classList.remove('hidden');

            if (item.status === 'Prestado') {
                loanedField.classList.remove('hidden');
            } else {
                loanedField.classList.add('hidden');
            }
        };

        /**
         * Deletes an item from Firestore.
         * @param {string} id - The ID of the item to delete.
         */
        const handleDelete = async (id) => {
            if (!db || !userId) {
                showMessage('Error de conexión con la base de datos.', 'error');
                return;
            }
            try {
                const itemDocRef = db.collection(`artifacts/${appId}/users/${userId}/${currentView}`).doc(id);
                await itemDocRef.delete();
                showMessage('Artículo eliminado correctamente.', 'success');
            } catch (e) {
                console.error("Error deleting document: ", e);
                showMessage('Error al eliminar el artículo.', 'error');
            }
        };

        // Event Listeners
        window.addEventListener('load', initializeFirebase);

        // View switching logic
        viewBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                viewBtns.forEach(b => {
                    b.classList.remove('bg-indigo-600', 'text-white');
                    b.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-indigo-200');
                });
                btn.classList.add('bg-indigo-600', 'text-white');
                btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-indigo-200');

                currentView = btn.id === 'materials-btn' ? 'materials' : 'costumes';
                formTitle.textContent = `Añadir ${currentView === 'materials' ? 'Material' : 'Vestuario'}`;
                searchInput.placeholder = `Buscar ${currentView === 'materials' ? 'materiales' : 'vestuarios'}...`;
                
                // Toggle quantity and repair fields based on view
                if (currentView === 'materials') {
                    quantityField.classList.remove('hidden');
                    repairOption.disabled = false;
                } else {
                    quantityField.classList.add('hidden');
                    repairOption.disabled = true;
                    // Reset status to 'Almacen' if it was 'Reparacion'
                    if (document.getElementById('status').value === 'Reparación') {
                        document.getElementById('status').value = 'Almacén';
                    }
                }
                
                // Clear and reset form on view change
                itemForm.reset();
                editingItem = null;
                submitBtn.textContent = 'Añadir a Inventario';
                cancelBtn.classList.add('hidden');
                loanedField.classList.add('hidden');
                
                renderItems();
            });
        });

        // Handle status change to show/hide loanedTo field
        document.getElementById('status').addEventListener('change', (e) => {
            if (e.target.value === 'Prestado') {
                loanedField.classList.remove('hidden');
            } else {
                loanedField.classList.add('hidden');
            }
        });

        // Form submission handler
        itemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!db || !userId) {
                showMessage('Error de conexión con la base de datos.', 'error');
                return;
            }

            const formData = new FormData(itemForm);
            const itemData = {
                name: formData.get('name'),
                status: formData.get('status'),
                loanedTo: formData.get('loanedTo') || '',
            };

            // Add quantity for materials view
            if (currentView === 'materials') {
                itemData.quantity = parseInt(formData.get('quantity'), 10);
            }

            try {
                const collectionRef = db.collection(`artifacts/${appId}/users/${userId}/${currentView}`);
                if (editingItem) {
                    // Update existing item
                    await collectionRef.doc(editingItem.id).update(itemData);
                    showMessage('Artículo editado correctamente.', 'success');
                } else {
                    // Add new item
                    await collectionRef.add(itemData);
                    showMessage('Artículo agregado correctamente.', 'success');
                }
            } catch (error) {
                console.error("Error adding/editing document: ", error);
                showMessage('Error al guardar el artículo.', 'error');
            }

            // Reset form and editing state
            itemForm.reset();
            editingItem = null;
            submitBtn.textContent = 'Añadir a Inventario';
            cancelBtn.classList.add('hidden');
            loanedField.classList.add('hidden');
            document.getElementById('status').value = 'Almacén';
        });

        // Cancel editing handler
        cancelBtn.addEventListener('click', () => {
            itemForm.reset();
            editingItem = null;
            formTitle.textContent = `Añadir ${currentView === 'materials' ? 'Material' : 'Vestuario'}`;
            submitBtn.textContent = 'Añadir a Inventario';
            cancelBtn.classList.add('hidden');
            loanedField.classList.add('hidden');
            document.getElementById('status').value = 'Almacén';
        });

        // Search input handler
        searchInput.addEventListener('input', renderItems);
    </script>
</body>
</html>